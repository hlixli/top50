<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>üìä</title>

<!-- PWA / iOS Full Screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="üìä">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100' rx='20'/><text x='50' y='68' font-size='45' text-anchor='middle'>üìä</text></svg>">

<!-- Preconnect to API domains for faster first request -->
<link rel="preconnect" href="https://api.coingecko.com" crossorigin>
<link rel="preconnect" href="https://api.alternative.me" crossorigin>
<link rel="preconnect" href="https://assets.coingecko.com" crossorigin>
<link rel="preconnect" href="https://coin-images.coingecko.com" crossorigin>
<link rel="preconnect" href="https://corsproxy.io" crossorigin>
<link rel="dns-prefetch" href="https://api.coingecko.com">
<link rel="dns-prefetch" href="https://api.alternative.me">
<link rel="dns-prefetch" href="https://assets.coingecko.com">
<link rel="dns-prefetch" href="https://coin-images.coingecko.com">
<link rel="dns-prefetch" href="https://corsproxy.io">

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #222 transparent;
  }
  body {
    background: #000;
    color: #aaa;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    font-size: 16px;
    padding: 24px;
    padding-top: max(32px, env(safe-area-inset-top));
    padding-bottom: max(90px, env(safe-area-inset-bottom));
    padding-left: max(24px, env(safe-area-inset-left));
    padding-right: max(24px, env(safe-area-inset-right));
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  
  ::-webkit-scrollbar {
    width: 4px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: #222;
    border-radius: 2px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #333;
  }

  .last-update {
    font-size: 11px;
    color: #444;
    margin-bottom: 15px;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .crypto-list {
    width: 100%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã */
  .crypto-card {
    display: grid;
    grid-template-columns: 44px 1fr 90px auto;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 10px;
    transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    cursor: pointer;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
    contain: layout style paint;
    content-visibility: auto;
    contain-intrinsic-size: auto 72px;
    will-change: transform;
  }
  .crypto-card:hover {
    background: #111;
    border-color: #2a2a2a;
    transform: translateX(3px);
  }
  @media (hover: none) {
    .crypto-card:hover {
      transform: none;
    }
  }
  .crypto-card:active {
    transform: scale(0.99);
    background: #151515;
  }

  /* –†–∞–Ω–≥ */
  .crypto-rank {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #151515;
    border-radius: 50%;
    font-size: 14px;
    font-weight: 600;
    color: #666;
  }
  .crypto-rank.top3 {
    background: linear-gradient(135deg, #1a1a1a, #252525);
    color: #fff;
  }

  /* –ò–Ω—Ñ–æ –±–ª–æ–∫ */
  .crypto-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }
  .crypto-name-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .crypto-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #1a1a1a;
    content-visibility: auto;
  }
  .crypto-name {
    font-size: 17px;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .crypto-symbol {
    font-size: 13px;
    color: #555;
    text-transform: uppercase;
    font-weight: 500;
  }
  .crypto-mcap {
    font-size: 13px;
    color: #444;
  }

  /* –¶–µ–Ω–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
  .crypto-price-block {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .crypto-price {
    font-size: 17px;
    font-weight: 600;
    color: #fff;
    font-family: 'SF Mono', 'Menlo', 'Courier New', monospace;
  }
  .crypto-change {
    font-size: 12px;
    font-weight: 500;
    padding: 3px 7px;
    border-radius: 4px;
  }
  .crypto-change.positive {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }
  .crypto-change.negative {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }

  /* –ó–∞–≥—Ä—É–∑–∫–∞ */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 60px 20px;
    color: #555;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #1a1a1a;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .crypto-list .crypto-card {
    animation: fadeInUp 0.2s ease forwards;
  }

  /* –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ / —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
  @media (prefers-reduced-motion: reduce) {
    .crypto-list .crypto-card {
      animation: none;
    }
    .crypto-card {
      transition: none;
    }
    .spinner {
      animation: spin 1.5s linear infinite;
    }
    .fear-greed-indicator {
      transition: none;
    }
  }

  /* –û—à–∏–±–∫–∞ */
  .error {
    text-align: center;
    padding: 40px 20px;
    color: #ef4444;
  }
  .error-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
  }
  .error-message {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
  }
  .retry-btn {
    padding: 12px 24px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .retry-btn:hover {
    background: #252525;
  }

  /* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
  #refreshBtn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 48px;
    height: 48px;
    background: #111;
    border: 1px solid #333;
    border-radius: 50%;
    color: #888;
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    z-index: 50;
    -webkit-tap-highlight-color: transparent;
  }
  #refreshBtn:hover:not(:disabled) {
    background: #1a1a1a;
  }
  #refreshBtn:disabled {
    background: #0a0a0a;
    color: #555;
    cursor: default;
  }

  /* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
  .market-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    width: 100%;
    max-width: 800px;
    margin-bottom: 25px;
  }
  .stat-card {
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    padding: 14px;
    contain: layout style;
  }
  .stat-card.with-chart {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .stat-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .stat-label {
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .stat-value {
    font-size: 17px;
    font-weight: 600;
    color: #fff;
    transition: color 0.3s ease;
  }
  .stat-value.updated {
    animation: pulse 0.5s ease;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .stat-chart {
    width: 100%;
    height: 40px;
  }
  
  /* Fear & Greed */
  .fear-greed-card {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .fear-greed-meter {
    width: 100%;
    height: 6px;
    background: linear-gradient(to right, #ef4444, #f59e0b, #22c55e);
    border-radius: 3px;
    position: relative;
  }
  .fear-greed-indicator {
    position: absolute;
    top: -3px;
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 0 4px rgba(0,0,0,0.5);
    transition: left 0.5s ease-out;
  }
  .fear-greed-label {
    font-size: 11px;
    color: #666;
    text-align: center;
  }
  
  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
  .stat-change {
    font-size: 11px;
    font-weight: 500;
    margin-top: 4px;
  }
  .stat-change.positive {
    color: #22c55e;
  }
  .stat-change.negative {
    color: #ef4444;
  }
  .stat-sub {
    font-size: 10px;
    color: #444;
    margin-top: 4px;
  }
  
  #marketStats2 {
    grid-template-columns: repeat(4, 1fr);
    margin-bottom: 20px;
  }
  
  @media (max-width: 700px) {
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  /* –°–ø–∞—Ä–∫–ª–∞–π–Ω –¥–ª—è –∫—Ä–∏–ø—Ç—ã */
  .crypto-sparkline {
    width: 90px;
    height: 36px;
    flex-shrink: 0;
  }
  .crypto-sparkline svg {
    width: 100%;
    height: 100%;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
  @media (max-width: 768px) {
    body {
      padding: 20px;
      padding-top: max(26px, env(safe-area-inset-top));
    }
    .crypto-card {
      grid-template-columns: 38px 1fr 80px auto;
      gap: 12px;
      padding: 16px 18px;
    }
    .crypto-sparkline {
      width: 80px;
      height: 34px;
    }
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  @media (max-width: 480px) {
    body {
      padding: 14px;
      padding-top: max(16px, env(safe-area-inset-top));
      font-size: 15px;
    }
    .last-update {
      font-size: 12px;
      margin-bottom: 14px;
    }
    .crypto-card {
      grid-template-columns: 24px 1fr 75px auto;
      gap: 8px;
      padding: 14px 12px;
    }
    .crypto-sparkline {
      width: 75px;
      height: 32px;
    }
    .crypto-rank {
      width: 24px;
      height: 24px;
      font-size: 11px;
    }
    .crypto-name {
      font-size: 15px;
      max-width: 65px;
    }
    .crypto-symbol {
      font-size: 12px;
    }
    .crypto-mcap {
      font-size: 12px;
    }
    .crypto-icon {
      width: 24px;
      height: 24px;
    }
    .crypto-price {
      font-size: 15px;
    }
    .crypto-change {
      font-size: 11px;
      padding: 3px 6px;
    }
    .crypto-price-block {
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }
    .market-stats {
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      padding: 14px;
    }
    .stat-label {
      font-size: 11px;
    }
    .stat-value {
      font-size: 16px;
    }
    .stat-chart {
      height: 38px;
    }
    #refreshBtn {
      bottom: 16px;
      right: 16px;
      width: 46px;
      height: 46px;
      font-size: 12px;
    }
    .crypto-name-row {
      gap: 6px;
    }
  }

  /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
  @media (max-width: 360px) {
    .crypto-card {
      grid-template-columns: 22px 1fr 65px auto;
      padding: 12px 10px;
      gap: 6px;
    }
    .crypto-sparkline {
      width: 65px;
      height: 28px;
    }
    .crypto-rank {
      width: 22px;
      height: 22px;
      font-size: 10px;
    }
    .crypto-name {
      max-width: 55px;
      font-size: 14px;
    }
    .crypto-price {
      font-size: 14px;
    }
    #marketStats2 {
      grid-template-columns: 1fr 1fr;
    }
    .stat-value {
      font-size: 14px;
    }
  }

  .footer-space {
    width: 100%;
    height: 80px;
    flex-shrink: 0;
  }

  /* –õ–æ–≥–æ—Ç–∏–ø */
  .site-logo {
    width: 60px;
    height: 60px;
    margin-bottom: 20px;
    border-radius: 12px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    pointer-events: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
  }
  @media (max-width: 480px) {
    .site-logo {
      width: 50px;
      height: 50px;
      margin-bottom: 16px;
      border-radius: 10px;
    }
  }
</style>
</head>
<body>

<img src="Logo1-31.png" alt="" class="site-logo" draggable="false" oncontextmenu="return false;" width="60" height="60" decoding="async" fetchpriority="high">

<div class="last-update" id="lastUpdate">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div class="market-stats" id="marketStats">
  <div class="stat-card with-chart">
    <div class="stat-header">
      <div class="stat-info">
        <div class="stat-label">–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è</div>
        <div class="stat-value" id="totalMcap">‚Äî</div>
      </div>
    </div>
    <canvas class="stat-chart" id="mcapChart"></canvas>
  </div>
  <div class="stat-card fear-greed-card">
    <div class="stat-info">
      <div class="stat-label">Fear & Greed Index</div>
      <div class="stat-value" id="fearGreedValue">‚Äî</div>
    </div>
    <div class="fear-greed-meter">
      <div class="fear-greed-indicator" id="fearGreedIndicator" style="left: 50%"></div>
    </div>
    <div class="fear-greed-label" id="fearGreedLabel">‚Äî</div>
  </div>
</div>

<div class="market-stats" id="marketStats2">
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –î–æ–º–∏–Ω–∞—Ü–∏—è</div>
      <div class="stat-value" id="btcDominance">‚Äî</div>
    </div>
    <div class="stat-change" id="btcDomChange"></div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">–û–±—ä—ë–º 24—á</div>
      <div class="stat-value" id="totalVolume">‚Äî</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –¥–æ ATH</div>
      <div class="stat-value" id="btcToAth">‚Äî</div>
    </div>
    <div class="stat-sub" id="btcAthPrice"></div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –æ—Ç ATH</div>
      <div class="stat-value" id="btcFromAth">‚Äî</div>
    </div>
    <div class="stat-sub" id="btcCurrentPrice"></div>
  </div>
</div>

<div class="crypto-list" id="cryptoList">
  <div class="loading">
    <div class="spinner"></div>
    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
  </div>
</div>

<button id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>

<div class="footer-space"></div>

<script>
  // === PERFORMANCE-OPTIMIZED CRYPTO DASHBOARD ===
  
  // CORS Proxy –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  const CORS_PROXY = 'https://corsproxy.io/?';
  const API_BASE = 'https://api.coingecko.com/api/v3';
  const needsProxy = location.protocol === 'file:';
  
  function apiUrl(endpoint) {
    const fullUrl = API_BASE + endpoint;
    return needsProxy ? CORS_PROXY + encodeURIComponent(fullUrl) : fullUrl;
  }
  
  // === API RESPONSE CACHE ===
  const apiCache = new Map();
  const CACHE_TTL = 45000; // 45 —Å–µ–∫—É–Ω–¥
  
  async function cachedFetch(url, ttl = CACHE_TTL) {
    const cached = apiCache.get(url);
    if (cached && Date.now() - cached.time < ttl) {
      return cached.data;
    }
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 12000); // 12s timeout
    try {
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      if (!res.ok) {
        if (res.status === 429) throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.');
        throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
      const data = await res.json();
      apiCache.set(url, { data, time: Date.now() });
      return data;
    } catch (e) {
      clearTimeout(timeout);
      // Return stale cache on error if available
      if (cached) return cached.data;
      throw e;
    }
  }
  
  // === DOM REFERENCES (cached once) ===
  const $ = id => document.getElementById(id);
  const DOM = {
    list: $('cryptoList'),
    lastUpdate: $('lastUpdate'),
    totalMcap: $('totalMcap'),
    totalVolume: $('totalVolume'),
    btcDominance: $('btcDominance'),
    btcDomChange: $('btcDomChange'),
    fearGreedValue: $('fearGreedValue'),
    fearGreedIndicator: $('fearGreedIndicator'),
    fearGreedLabel: $('fearGreedLabel'),
    btcToAth: $('btcToAth'),
    btcAthPrice: $('btcAthPrice'),
    btcFromAth: $('btcFromAth'),
    btcCurrentPrice: $('btcCurrentPrice'),
    mcapChart: $('mcapChart'),
  };
  
  // === FORMATTING (optimized ‚Äî avoid toLocaleString overhead) ===
  const fmtCompact = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
  const fmtDecimal2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const fmtDecimal4 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 6 });
  
  function formatPrice(p) {
    if (p >= 1000) return '$' + fmtCompact.format(p);
    if (p >= 1) return '$' + fmtDecimal2.format(p);
    return '$' + fmtDecimal4.format(p);
  }
  
  function formatMarketCap(m) {
    if (m >= 1e12) return '$' + (m / 1e12).toFixed(2) + 'T';
    if (m >= 1e9) return '$' + (m / 1e9).toFixed(2) + 'B';
    if (m >= 1e6) return '$' + (m / 1e6).toFixed(2) + 'M';
    return '$' + fmtCompact.format(m);
  }
  
  function formatChange(c) {
    return (c >= 0 ? '+' : '') + c.toFixed(2) + '%';
  }
  
  // === STABLECOINS (Set for O(1) lookup) ===
  const STABLECOINS = new Set(['usdt','usdc','dai','busd','tusd','usdp','usdd','frax','lusd','gusd','susd','eurs','fdusd','pyusd','usde','eurc']);
  
  // === SPARKLINE (lazy-rendered via IntersectionObserver) ===
  function createSparklineSVG(data, isPositive, isStable) {
    const w = 90, h = 36, p = 2;
    if (isStable) {
      return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><line x1="${p}" y1="${h/2}" x2="${w-p}" y2="${h/2}" stroke="#444" stroke-width="1.5"/></svg>`;
    }
    if (!data || !data.length) return '';
    
    const step = Math.max(1, (data.length / 24) | 0);
    let min = Infinity, max = -Infinity;
    const sampled = [];
    for (let i = 0; i < data.length; i += step) {
      const v = data[i];
      sampled.push(v);
      if (v < min) min = v;
      if (v > max) max = v;
    }
    const range = max - min || 1;
    const len = sampled.length - 1;
    
    let d = '';
    for (let i = 0; i <= len; i++) {
      const x = p + (i / len) * (w - p * 2);
      const y = h - p - ((sampled[i] - min) / range) * (h - p * 2);
      if (i === 0) { d = `M${x.toFixed(1)},${y.toFixed(1)}`; continue; }
      const px = p + ((i-1) / len) * (w - p * 2);
      const py = h - p - ((sampled[i-1] - min) / range) * (h - p * 2);
      const mx = ((px + x) / 2).toFixed(1);
      const my = ((py + y) / 2).toFixed(1);
      d += `Q${px.toFixed(1)},${py.toFixed(1)} ${mx},${my}`;
    }
    const lx = (p + (w - p * 2)).toFixed(1);
    const ly = (h - p - ((sampled[len] - min) / range) * (h - p * 2)).toFixed(1);
    d += `L${lx},${ly}`;
    
    const color = isPositive ? '#22c55e' : '#ef4444';
    return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="${d}"/></svg>`;
  }
  
  // Lazy sparkline observer ‚Äî renders SVG only when card scrolls into view
  let sparklineObserver;
  function setupSparklineObserver() {
    if (sparklineObserver) sparklineObserver.disconnect();
    sparklineObserver = new IntersectionObserver((entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          const el = entry.target;
          const svg = el.getAttribute('data-svg');
          if (svg) {
            el.innerHTML = svg;
            el.removeAttribute('data-svg');
          }
          sparklineObserver.unobserve(el);
        }
      }
    }, { rootMargin: '200px 0px' }); // preload 200px ahead
  }
  setupSparklineObserver();
  
  // === MCAP CHART (optimized canvas) ===
  function drawMcapChart(data) {
    const canvas = DOM.mcapChart;
    if (!canvas || !data || !data.length) return;
    
    const ctx = canvas.getContext('2d', { alpha: false });
    const dpr = Math.min(window.devicePixelRatio || 1, 2); // cap at 2x for perf
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    ctx.scale(dpr, dpr);
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, w, h);
    
    const pad = 4;
    const prices = data;
    let min = Infinity, max = -Infinity;
    for (let i = 0; i < prices.length; i++) {
      const v = prices[i][1];
      if (v < min) min = v;
      if (v > max) max = v;
    }
    const range = max - min || 1;
    const len = prices.length - 1;
    
    // Fill gradient
    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(59,130,246,0.3)');
    grad.addColorStop(1, 'rgba(59,130,246,0)');
    
    ctx.beginPath();
    ctx.moveTo(pad, h);
    for (let i = 0; i <= len; i++) {
      ctx.lineTo(
        pad + (i / len) * (w - pad * 2),
        h - pad - ((prices[i][1] - min) / range) * (h - pad * 2)
      );
    }
    ctx.lineTo(w - pad, h);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();
    
    // Line
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (let i = 0; i <= len; i++) {
      const x = pad + (i / len) * (w - pad * 2);
      const y = h - pad - ((prices[i][1] - min) / range) * (h - pad * 2);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.stroke();
  }
  
  // === FEAR & GREED INDEX ===
  async function loadFearGreedIndex() {
    try {
      const url = needsProxy
        ? CORS_PROXY + encodeURIComponent('https://api.alternative.me/fng/?limit=1')
        : 'https://api.alternative.me/fng/?limit=1';
      const data = await cachedFetch(url, 120000); // cache 2min
      if (data?.data?.[0]) {
        const v = parseInt(data.data[0].value);
        DOM.fearGreedValue.textContent = v;
        DOM.fearGreedIndicator.style.left = v + '%';
        DOM.fearGreedLabel.textContent = data.data[0].value_classification;
      }
    } catch (e) {
      DOM.fearGreedValue.textContent = '‚Äî';
      DOM.fearGreedLabel.textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    }
  }
  
  // === MCAP CHART LOADER ===
  async function loadMcapChart() {
    try {
      const data = await cachedFetch(
        apiUrl('/coins/bitcoin/market_chart?vs_currency=usd&days=365'),
        300000 // cache 5min ‚Äî chart data doesn't change fast
      );
      if (data?.market_caps?.length) {
        const sampled = data.market_caps.filter((_, i) => i % 4 === 0);
        requestAnimationFrame(() => drawMcapChart(sampled));
      }
    } catch (e) {
      console.error('Chart error:', e);
    }
  }
  
  // === CRYPTO LIST (DocumentFragment + lazy sparklines) ===
  function getSmallImage(imageUrl) {
    // CoinGecko images: replace /large/ with /small/ for faster load
    if (typeof imageUrl === 'string') {
      return imageUrl.replace('/large/', '/small/');
    }
    return imageUrl;
  }
  
  async function loadCryptoData() {
    try {
      const coins = await cachedFetch(
        apiUrl('/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=true&price_change_percentage=24h,7d')
      );
      
      // Load global stats in parallel (no artificial delay)
      const globalPromise = cachedFetch(apiUrl('/global'));
      
      // Build cards with DocumentFragment
      const frag = document.createDocumentFragment();
      
      for (let i = 0; i < coins.length; i++) {
        const coin = coins[i];
        const isStable = STABLECOINS.has(coin.symbol.toLowerCase());
        const sparkData = coin.sparkline_in_7d?.price;
        const isPositive = (coin.price_change_percentage_7d_in_currency || 0) >= 0;
        const change24 = coin.price_change_percentage_24h || 0;
        const positive24 = change24 >= 0;
        
        const a = document.createElement('a');
        a.href = `https://coinmarketcap.com/currencies/${coin.id}/`;
        a.target = '_blank';
        a.rel = 'noopener';
        a.className = 'crypto-card';
        a.style.animationDelay = (i < 12 ? i * 20 : 0) + 'ms'; // stagger only visible cards
        
        // Pre-generate sparkline SVG string
        const svgStr = createSparklineSVG(sparkData, isPositive, isStable);
        
        a.innerHTML = `<div class="crypto-rank${i < 3 ? ' top3' : ''}">${i + 1}</div><div class="crypto-info"><div class="crypto-name-row"><img class="crypto-icon" src="${getSmallImage(coin.image)}" alt="" width="32" height="32" loading="${i < 8 ? 'eager' : 'lazy'}" decoding="async"><span class="crypto-name">${coin.name}</span><span class="crypto-symbol">${coin.symbol}</span></div><div class="crypto-mcap">MCap: ${formatMarketCap(coin.market_cap)}</div></div><div class="crypto-sparkline" ${i >= 8 ? `data-svg='${svgStr.replace(/'/g,"&#39;")}'` : ''}>${i < 8 ? svgStr : ''}</div><div class="crypto-price-block"><div class="crypto-price">${formatPrice(coin.current_price)}</div><div class="crypto-change ${positive24 ? 'positive' : 'negative'}">${formatChange(change24)}</div></div>`;
        
        frag.appendChild(a);
      }
      
      // Single DOM write
      DOM.list.textContent = '';
      DOM.list.appendChild(frag);
      
      // Setup lazy sparkline rendering for cards below fold
      DOM.list.querySelectorAll('.crypto-sparkline[data-svg]').forEach(el => {
        sparklineObserver.observe(el);
      });
      
      // Update time
      const now = new Date();
      DOM.lastUpdate.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      
      // Process global stats (awaited in parallel)
      try {
        const globalData = await globalPromise;
        if (globalData?.data) {
          const d = globalData.data;
          DOM.totalMcap.textContent = formatMarketCap(d.total_market_cap.usd);
          DOM.totalVolume.textContent = formatMarketCap(d.total_volume.usd);
          DOM.btcDominance.textContent = d.market_cap_percentage.btc.toFixed(1) + '%';
          
          const mcapChange = d.market_cap_change_percentage_24h_usd;
          if (mcapChange !== undefined) {
            DOM.btcDomChange.textContent = (mcapChange >= 0 ? '+' : '') + mcapChange.toFixed(2) + '% mcap 24h';
            DOM.btcDomChange.className = 'stat-change ' + (mcapChange >= 0 ? 'positive' : 'negative');
          }
        }
      } catch (e) { /* global stats are non-critical */ }
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      if (DOM.list.querySelector('.loading') || !DOM.list.children.length) {
        DOM.list.innerHTML = `<div class="error"><div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div><div class="error-message">${error.message}</div><button class="retry-btn" onclick="loadAllData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button></div>`;
      }
    }
  }
  
  // === BTC ATH ===
  async function loadBtcAth() {
    try {
      const data = await cachedFetch(
        apiUrl('/coins/bitcoin?localization=false&tickers=false&community_data=false&developer_data=false'),
        60000 // cache 1min
      );
      if (data?.market_data) {
        const md = data.market_data;
        const cur = md.current_price.usd;
        const ath = md.ath.usd;
        const athDate = new Date(md.ath_date.usd);
        const toAth = ((ath - cur) / cur * 100);
        const fromAth = ((cur - ath) / ath * 100);
        
        DOM.btcToAth.textContent = '+' + toAth.toFixed(1) + '%';
        DOM.btcToAth.style.color = toAth > 0 ? '#f59e0b' : '#22c55e';
        DOM.btcAthPrice.textContent = 'ATH: $' + fmtCompact.format(ath) + ' (' + athDate.toLocaleDateString('ru-RU', {month:'short',year:'numeric'}) + ')';
        
        DOM.btcFromAth.textContent = fromAth.toFixed(1) + '%';
        DOM.btcFromAth.style.color = fromAth >= 0 ? '#22c55e' : '#ef4444';
        DOM.btcCurrentPrice.textContent = '–°–µ–π—á–∞—Å: $' + fmtCompact.format(cur);
      }
    } catch (e) {
      DOM.btcToAth.textContent = '‚Äî';
      DOM.btcFromAth.textContent = '‚Äî';
    }
  }
  
  // === LOAD ALL DATA (parallel where possible) ===
  async function loadAllData() {
    try {
      // Load main list first (highest priority)
      await loadCryptoData();
      // Then load secondary data in parallel
      await Promise.allSettled([loadFearGreedIndex(), loadBtcAth()]);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
    }
  }
  
  // === REFRESH BUTTON (passive listener) ===
  const COOLDOWN = 60;
  let countdown = 0, timer = null;
  const btn = $('refreshBtn');
  
  function updateBtn() {
    btn.textContent = countdown > 0 ? countdown : '‚Üª';
    btn.disabled = countdown > 0;
  }
  
  function startCooldown() {
    countdown = COOLDOWN;
    updateBtn();
    if (timer) clearInterval(timer);
    timer = setInterval(() => {
      if (--countdown <= 0) { clearInterval(timer); timer = null; }
      updateBtn();
    }, 1000);
  }
  
  btn.addEventListener('click', () => {
    if (countdown <= 0) { loadAllData(); startCooldown(); }
  }, { passive: true });
  
  // === INIT ===
  // Load critical data immediately
  loadAllData();
  startCooldown();
  
  // Load chart after first paint (non-blocking)
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => loadMcapChart(), { timeout: 2000 });
  } else {
    setTimeout(loadMcapChart, 100);
  }
  
  // Auto-refresh every 90s
  setInterval(() => {
    if (countdown <= 0) { loadAllData(); startCooldown(); }
  }, 90000);
  
  // === SERVICE WORKER REGISTRATION ===
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    });
  }
</script>

</body>
</html>
