<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>üìä Top 50 Crypto</title>

<!-- PWA / iOS Full Screen -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Top 50">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100' rx='20'/><text x='50' y='68' font-size='45' text-anchor='middle'>üìä</text></svg>">

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    overflow-x: hidden;
    scrollbar-width: thin;
    scrollbar-color: #222 transparent;
  }
  body {
    background: #000;
    color: #aaa;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    font-size: 15px;
    padding: 22px;
    padding-top: max(30px, env(safe-area-inset-top));
    padding-bottom: max(80px, env(safe-area-inset-bottom));
    padding-left: max(22px, env(safe-area-inset-left));
    padding-right: max(22px, env(safe-area-inset-right));
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  
  ::-webkit-scrollbar {
    width: 4px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: #222;
    border-radius: 2px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #333;
  }

  .last-update {
    font-size: 11px;
    color: #444;
    margin-bottom: 15px;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .crypto-list {
    width: 100%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã */
  .crypto-card {
    display: grid;
    grid-template-columns: 40px 1fr 80px auto;
    align-items: center;
    gap: 12px;
    padding: 16px 18px;
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    transition: all 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }
  .crypto-card:hover {
    background: #111;
    border-color: #2a2a2a;
    transform: translateX(3px);
  }
  @media (hover: none) {
    .crypto-card:hover {
      transform: none;
    }
  }
  .crypto-card:active {
    transform: scale(0.99);
    background: #151515;
  }

  /* –†–∞–Ω–≥ */
  .crypto-rank {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #151515;
    border-radius: 50%;
    font-size: 13px;
    font-weight: 600;
    color: #666;
  }
  .crypto-rank.top3 {
    background: linear-gradient(135deg, #1a1a1a, #252525);
    color: #fff;
  }

  /* –ò–Ω—Ñ–æ –±–ª–æ–∫ */
  .crypto-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 0;
  }
  .crypto-name-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .crypto-icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #1a1a1a;
  }
  .crypto-name {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .crypto-symbol {
    font-size: 12px;
    color: #555;
    text-transform: uppercase;
    font-weight: 500;
  }
  .crypto-mcap {
    font-size: 12px;
    color: #444;
  }

  /* –¶–µ–Ω–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
  .crypto-price-block {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .crypto-price {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    font-family: 'SF Mono', 'Menlo', 'Courier New', monospace;
  }
  .crypto-change {
    font-size: 11px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 3px;
  }
  .crypto-change.positive {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }
  .crypto-change.negative {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }

  /* –ó–∞–≥—Ä—É–∑–∫–∞ */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 60px 20px;
    color: #555;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #1a1a1a;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .crypto-list .crypto-card {
    animation: fadeInUp 0.3s ease forwards;
  }

  /* –û—à–∏–±–∫–∞ */
  .error {
    text-align: center;
    padding: 40px 20px;
    color: #ef4444;
  }
  .error-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
  }
  .error-message {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
  }
  .retry-btn {
    padding: 12px 24px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .retry-btn:hover {
    background: #252525;
  }

  /* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */
  .refresh-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    background: #111;
    border: 1px solid #333;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 50;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .refresh-btn svg {
    width: 22px;
    height: 22px;
    color: #888;
  }
  .refresh-btn.loading {
    opacity: 0.5;
    pointer-events: none;
  }
  .refresh-btn.cooldown {
    opacity: 0.3;
    pointer-events: none;
  }
  .refresh-btn .cooldown-timer {
    position: absolute;
    font-size: 11px;
    color: #666;
    font-weight: 600;
  }

  /* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
  .market-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    width: 100%;
    max-width: 800px;
    margin-bottom: 25px;
  }
  .stat-card {
    background: #0a0a0a;
    border: 1px solid #1a1a1a;
    border-radius: 8px;
    padding: 14px;
  }
  .stat-card.with-chart {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .stat-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .stat-label {
    font-size: 10px;
    color: #555;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .stat-value {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    transition: color 0.3s ease;
  }
  .stat-value.updated {
    animation: pulse 0.5s ease;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .stat-chart {
    width: 100%;
    height: 40px;
  }
  
  /* Fear & Greed */
  .fear-greed-card {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .fear-greed-meter {
    width: 100%;
    height: 6px;
    background: linear-gradient(to right, #ef4444, #f59e0b, #22c55e);
    border-radius: 3px;
    position: relative;
  }
  .fear-greed-indicator {
    position: absolute;
    top: -3px;
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 0 4px rgba(0,0,0,0.5);
    transition: left 0.5s ease-out;
  }
  .fear-greed-label {
    font-size: 11px;
    color: #666;
    text-align: center;
  }
  
  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
  .stat-change {
    font-size: 11px;
    font-weight: 500;
    margin-top: 4px;
  }
  .stat-change.positive {
    color: #22c55e;
  }
  .stat-change.negative {
    color: #ef4444;
  }
  .stat-sub {
    font-size: 10px;
    color: #444;
    margin-top: 4px;
  }
  
  #marketStats2 {
    grid-template-columns: repeat(4, 1fr);
    margin-bottom: 20px;
  }
  
  @media (max-width: 700px) {
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  /* –°–ø–∞—Ä–∫–ª–∞–π–Ω –¥–ª—è –∫—Ä–∏–ø—Ç—ã */
  .crypto-sparkline {
    width: 80px;
    height: 32px;
    flex-shrink: 0;
  }
  .crypto-sparkline svg {
    width: 100%;
    height: 100%;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
  @media (max-width: 768px) {
    body {
      padding: 18px;
      padding-top: max(25px, env(safe-area-inset-top));
    }
    .crypto-card {
      grid-template-columns: 36px 1fr 70px auto;
      gap: 10px;
      padding: 14px 16px;
    }
    .crypto-sparkline {
      width: 70px;
      height: 30px;
    }
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  @media (max-width: 480px) {
    body {
      padding: 12px;
      padding-top: max(15px, env(safe-area-inset-top));
      font-size: 14px;
    }
    .last-update {
      font-size: 10px;
      margin-bottom: 12px;
    }
    .crypto-card {
      grid-template-columns: 28px 1fr auto;
      gap: 8px;
      padding: 12px;
    }
    .crypto-sparkline {
      display: none;
    }
    .crypto-rank {
      width: 28px;
      height: 28px;
      font-size: 11px;
    }
    .crypto-name {
      font-size: 13px;
    }
    .crypto-symbol {
      font-size: 10px;
    }
    .crypto-mcap {
      font-size: 10px;
    }
    .crypto-icon {
      width: 22px;
      height: 22px;
    }
    .crypto-price {
      font-size: 13px;
    }
    .crypto-change {
      font-size: 9px;
      padding: 2px 4px;
    }
    .crypto-price-block {
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .market-stats {
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }
    #marketStats2 {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    .stat-card {
      padding: 12px;
    }
    .stat-label {
      font-size: 9px;
    }
    .stat-value {
      font-size: 14px;
    }
    .stat-chart {
      height: 35px;
    }
    .refresh-btn {
      bottom: 15px;
      right: 15px;
      width: 44px;
      height: 44px;
    }
    .refresh-btn svg {
      width: 20px;
      height: 20px;
    }
    .crypto-name-row {
      gap: 6px;
    }
  }

  /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
  @media (max-width: 360px) {
    .crypto-card {
      padding: 10px;
    }
    .crypto-name {
      max-width: 100px;
    }
    #marketStats2 {
      grid-template-columns: 1fr 1fr;
    }
    .stat-value {
      font-size: 13px;
    }
  }

  .footer-space {
    width: 100%;
    height: 80px;
    flex-shrink: 0;
  }
</style>
</head>
<body>

<div class="last-update" id="lastUpdate">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div class="market-stats" id="marketStats">
  <div class="stat-card with-chart">
    <div class="stat-header">
      <div class="stat-info">
        <div class="stat-label">–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è</div>
        <div class="stat-value" id="totalMcap">‚Äî</div>
      </div>
    </div>
    <canvas class="stat-chart" id="mcapChart"></canvas>
  </div>
  <div class="stat-card fear-greed-card">
    <div class="stat-info">
      <div class="stat-label">Fear & Greed Index</div>
      <div class="stat-value" id="fearGreedValue">‚Äî</div>
    </div>
    <div class="fear-greed-meter">
      <div class="fear-greed-indicator" id="fearGreedIndicator" style="left: 50%"></div>
    </div>
    <div class="fear-greed-label" id="fearGreedLabel">‚Äî</div>
  </div>
</div>

<div class="market-stats" id="marketStats2">
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –î–æ–º–∏–Ω–∞—Ü–∏—è</div>
      <div class="stat-value" id="btcDominance">‚Äî</div>
    </div>
    <div class="stat-change" id="btcDomChange"></div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">–û–±—ä—ë–º 24—á</div>
      <div class="stat-value" id="totalVolume">‚Äî</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –¥–æ ATH</div>
      <div class="stat-value" id="btcToAth">‚Äî</div>
    </div>
    <div class="stat-sub" id="btcAthPrice"></div>
  </div>
  <div class="stat-card">
    <div class="stat-info">
      <div class="stat-label">BTC –æ—Ç ATH</div>
      <div class="stat-value" id="btcFromAth">‚Äî</div>
    </div>
    <div class="stat-sub" id="btcCurrentPrice"></div>
  </div>
</div>

<div class="crypto-list" id="cryptoList">
  <div class="loading">
    <div class="spinner"></div>
    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
  </div>
</div>

<button class="refresh-btn" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M23 4v6h-6"/>
    <path d="M1 20v-6h6"/>
    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
  </svg>
</button>

<div class="footer-space"></div>

<script>
  // CORS Proxy –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  const CORS_PROXY = 'https://corsproxy.io/?';
  const API_BASE = 'https://api.coingecko.com/api/v3';
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–µ–Ω –ª–∏ proxy (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª)
  const needsProxy = window.location.protocol === 'file:';
  const API_URL = needsProxy ? CORS_PROXY + encodeURIComponent(API_BASE) : API_BASE;
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è URL —Å proxy
  function apiUrl(endpoint) {
    const fullUrl = API_BASE + endpoint;
    return needsProxy ? CORS_PROXY + encodeURIComponent(fullUrl) : fullUrl;
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
  function formatPrice(price) {
    if (price >= 1000) {
      return '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
    } else if (price >= 1) {
      return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } else {
      return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 6 });
    }
  }
  
  function formatMarketCap(mcap) {
    if (mcap >= 1e12) {
      return '$' + (mcap / 1e12).toFixed(2) + 'T';
    } else if (mcap >= 1e9) {
      return '$' + (mcap / 1e9).toFixed(2) + 'B';
    } else if (mcap >= 1e6) {
      return '$' + (mcap / 1e6).toFixed(2) + 'M';
    }
    return '$' + mcap.toLocaleString();
  }
  
  function formatChange(change) {
    const sign = change >= 0 ? '+' : '';
    return sign + change.toFixed(2) + '%';
  }
  
  // –°–ø–∏—Å–æ–∫ —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤
  const STABLECOINS = ['usdt', 'usdc', 'dai', 'busd', 'tusd', 'usdp', 'usdd', 'frax', 'lusd', 'gusd', 'susd', 'eurs', 'fdusd', 'pyusd', 'usde', 'eurc'];
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–Ω–µ—Ç–∞ —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–º
  function isStablecoin(symbol) {
    return STABLECOINS.includes(symbol.toLowerCase());
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ SVG —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞
  function createSparkline(data, isPositive, isStable = false) {
    if (!data || data.length === 0) return '';
    
    const width = 80;
    const height = 32;
    const padding = 2;
    
    // –î–ª—è —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤ - –ø—Ä—è–º–∞—è —Å–µ—Ä–∞—è –ª–∏–Ω–∏—è
    if (isStable) {
      const midY = height / 2;
      return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
        <line x1="${padding}" y1="${midY}" x2="${width - padding}" y2="${midY}" stroke="#444" stroke-width="1.5" />
      </svg>`;
    }
    
    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min || 1;
    
    const points = data.map((val, i) => {
      const x = padding + (i / (data.length - 1)) * (width - padding * 2);
      const y = height - padding - ((val - min) / range) * (height - padding * 2);
      return `${x},${y}`;
    }).join(' ');
    
    const color = isPositive ? '#22c55e' : '#ef4444';
    
    return `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
      <polyline fill="none" stroke="${color}" stroke-width="1.5" points="${points}" />
    </svg>`;
  }
  
  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
  function drawMcapChart(data) {
    const canvas = document.getElementById('mcapChart');
    if (!canvas || !data || data.length === 0) return;
    
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Å —É—á—ë—Ç–æ–º DPR
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    
    const width = rect.width;
    const height = rect.height;
    const padding = 4;
    
    const prices = data.map(d => d[1]);
    const min = Math.min(...prices);
    const max = Math.max(...prices);
    const range = max - min || 1;
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–¥ –ª–∏–Ω–∏–µ–π
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
    
    // –°–æ–∑–¥–∞—ë–º –ø—É—Ç—å –¥–ª—è –∑–∞–ª–∏–≤–∫–∏
    ctx.beginPath();
    ctx.moveTo(padding, height);
    
    prices.forEach((price, i) => {
      const x = padding + (i / (prices.length - 1)) * (width - padding * 2);
      const y = height - padding - ((price - min) / range) * (height - padding * 2);
      ctx.lineTo(x, y);
    });
    
    ctx.lineTo(width - padding, height);
    ctx.closePath();
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    
    prices.forEach((price, i) => {
      const x = padding + (i / (prices.length - 1)) * (width - padding * 2);
      const y = height - padding - ((price - min) / range) * (height - padding * 2);
      
      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    
    ctx.stroke();
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ Fear & Greed Index
  async function loadFearGreedIndex() {
    try {
      const fngUrl = needsProxy 
        ? CORS_PROXY + encodeURIComponent('https://api.alternative.me/fng/?limit=1')
        : 'https://api.alternative.me/fng/?limit=1';
      const response = await fetch(fngUrl);
      if (!response.ok) return;
      const data = await response.json();
      
      if (data && data.data && data.data[0]) {
        const fng = data.data[0];
        const value = parseInt(fng.value);
        
        document.getElementById('fearGreedValue').textContent = value;
        document.getElementById('fearGreedIndicator').style.left = value + '%';
        document.getElementById('fearGreedLabel').textContent = fng.value_classification;
      }
    } catch (error) {
      console.error('Fear & Greed error:', error);
      document.getElementById('fearGreedValue').textContent = '‚Äî';
      document.getElementById('fearGreedLabel').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
    }
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –æ–±—â–µ–π –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ 1 –≥–æ–¥
  async function loadMcapChart() {
    try {
      const response = await fetch(
        apiUrl('/coins/bitcoin/market_chart?vs_currency=usd&days=365')
      );
      if (!response.ok) return;
      const data = await response.json();
      
      if (data && data.market_caps && data.market_caps.length > 0) {
        // –ë–µ—Ä—ë–º –∫–∞–∂–¥—ã–π 3-–π –¥–µ–Ω—å –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        const sampled = data.market_caps.filter((_, i) => i % 3 === 0);
        drawMcapChart(sampled);
      }
    } catch (error) {
      console.error('Chart error:', error);
      // Fallback - —Ä–∏—Å—É–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
      const canvas = document.getElementById('mcapChart');
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  async function loadCryptoData() {
    const list = document.getElementById('cryptoList');
    
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-50 –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç —Å–æ —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞–º–∏
      const response = await fetch(
        apiUrl('/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=true&price_change_percentage=24h,7d')
      );
      
      if (!response.ok) {
        if (response.status === 429) {
          throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.');
        }
        throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      }
      
      const coins = await response.json();
      
      // –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      await delay(200);
      const globalResponse = await fetch(apiUrl('/global'));
      
      if (globalResponse.ok) {
        const globalData = await globalResponse.json();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('totalMcap').textContent = formatMarketCap(globalData.data.total_market_cap.usd);
        document.getElementById('totalVolume').textContent = formatMarketCap(globalData.data.total_volume.usd);
        
        // BTC –î–æ–º–∏–Ω–∞—Ü–∏—è
        const btcDom = globalData.data.market_cap_percentage.btc;
        document.getElementById('btcDominance').textContent = btcDom.toFixed(1) + '%';
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞ 24—á
        const btcDomChange = globalData.data.market_cap_change_percentage_24h_usd;
        const btcDomEl = document.getElementById('btcDomChange');
        if (btcDomChange !== undefined) {
          btcDomEl.textContent = (btcDomChange >= 0 ? '+' : '') + btcDomChange.toFixed(2) + '% mcap 24h';
          btcDomEl.className = 'stat-change ' + (btcDomChange >= 0 ? 'positive' : 'negative');
        }
      }
      
      // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
      list.innerHTML = coins.map((coin, index) => {
        const sparklineData = coin.sparkline_in_7d?.price || [];
        const isPositive = (coin.price_change_percentage_7d_in_currency || 0) >= 0;
        const isStable = isStablecoin(coin.symbol);
        const sparklineSvg = createSparkline(sparklineData, isPositive, isStable);
        
        return `
        <a href="https://coinmarketcap.com/currencies/${coin.id}/" target="_blank" class="crypto-card">
          <div class="crypto-rank ${index < 3 ? 'top3' : ''}">${index + 1}</div>
          <div class="crypto-info">
            <div class="crypto-name-row">
              <img class="crypto-icon" src="${coin.image}" alt="${coin.name}" loading="lazy">
              <span class="crypto-name">${coin.name}</span>
              <span class="crypto-symbol">${coin.symbol}</span>
            </div>
            <div class="crypto-mcap">MCap: ${formatMarketCap(coin.market_cap)}</div>
          </div>
          <div class="crypto-sparkline">${sparklineSvg}</div>
          <div class="crypto-price-block">
            <div class="crypto-price">${formatPrice(coin.current_price)}</div>
            <div class="crypto-change ${coin.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
              ${formatChange(coin.price_change_percentage_24h || 0)}
            </div>
          </div>
        </a>
      `}).join('');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
      const now = new Date();
      document.getElementById('lastUpdate').textContent = 
        `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π
      if (list.querySelector('.loading') || list.children.length === 0) {
        list.innerHTML = `
          <div class="error">
            <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="error-message">${error.message}</div>
            <button class="retry-btn" onclick="loadAllData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          </div>
        `;
      }
    }
  }

  // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limit)
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ BTC ATH
  async function loadBtcAth() {
    try {
      const response = await fetch(apiUrl('/coins/bitcoin?localization=false&tickers=false&community_data=false&developer_data=false'));
      if (!response.ok) return;
      const data = await response.json();
      
      if (data && data.market_data) {
        const currentPrice = data.market_data.current_price.usd;
        const ath = data.market_data.ath.usd;
        const athDate = new Date(data.market_data.ath_date.usd);
        
        // –°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω—É–∂–Ω–æ –≤—ã—Ä–∞—Å—Ç–∏ –¥–æ ATH
        const toAth = ((ath - currentPrice) / currentPrice * 100);
        
        // –°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —É–ø–∞–ª–∞ —Ü–µ–Ω–∞ –æ—Ç ATH
        const fromAth = ((currentPrice - ath) / ath * 100);
        
        // BTC –¥–æ ATH
        document.getElementById('btcToAth').textContent = '+' + toAth.toFixed(1) + '%';
        document.getElementById('btcToAth').style.color = toAth > 0 ? '#f59e0b' : '#22c55e';
        document.getElementById('btcAthPrice').textContent = 
          'ATH: $' + ath.toLocaleString('en-US', {maximumFractionDigits: 0}) + 
          ' (' + athDate.toLocaleDateString('ru-RU', {month: 'short', year: 'numeric'}) + ')';
        
        // BTC –æ—Ç ATH
        document.getElementById('btcFromAth').textContent = fromAth.toFixed(1) + '%';
        document.getElementById('btcFromAth').style.color = fromAth >= 0 ? '#22c55e' : '#ef4444';
        document.getElementById('btcCurrentPrice').textContent = 
          '–°–µ–π—á–∞—Å: $' + currentPrice.toLocaleString('en-US', {maximumFractionDigits: 0});
      }
    } catch (error) {
      console.error('BTC ATH error:', error);
      document.getElementById('btcToAth').textContent = '‚Äî';
      document.getElementById('btcFromAth').textContent = '‚Äî';
    }
  }
  
  // –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
  async function loadAllData() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.classList.add('loading');
    
    try {
      await loadCryptoData();
      await delay(300);
      await loadFearGreedIndex();
      await delay(300);
      await loadBtcAth();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    } finally {
      refreshBtn.classList.remove('loading');
    }
  }
  
  // Cooldown –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç rate limit
  const COOLDOWN_TIME = 60000; // 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
  let lastRefreshTime = 0;
  let cooldownInterval = null;
  
  function startCooldown() {
    const refreshBtn = document.getElementById('refreshBtn');
    const svg = refreshBtn.querySelector('svg');
    lastRefreshTime = Date.now();
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
    let timerEl = refreshBtn.querySelector('.cooldown-timer');
    if (!timerEl) {
      timerEl = document.createElement('span');
      timerEl.className = 'cooldown-timer';
      refreshBtn.appendChild(timerEl);
    }
    
    refreshBtn.classList.add('cooldown');
    svg.style.display = 'none';
    
    function updateTimer() {
      const elapsed = Date.now() - lastRefreshTime;
      const remaining = Math.ceil((COOLDOWN_TIME - elapsed) / 1000);
      
      if (remaining <= 0) {
        refreshBtn.classList.remove('cooldown');
        svg.style.display = '';
        timerEl.textContent = '';
        clearInterval(cooldownInterval);
        cooldownInterval = null;
      } else {
        timerEl.textContent = remaining + 's';
      }
    }
    
    updateTimer();
    cooldownInterval = setInterval(updateTimer, 1000);
  }
  
  function canRefresh() {
    return Date.now() - lastRefreshTime >= COOLDOWN_TIME;
  }
  
  // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  document.getElementById('refreshBtn').addEventListener('click', function() {
    if (canRefresh()) {
      loadAllData();
      startCooldown();
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadAllData();
  loadMcapChart();
  startCooldown(); // –ó–∞–ø—É—Å–∫–∞–µ–º cooldown –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
  
  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 90 —Å–µ–∫—É–Ω–¥ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã API)
  setInterval(function() {
    if (canRefresh()) {
      loadAllData();
      startCooldown();
    }
  }, 90000);
</script>

</body>
</html>
